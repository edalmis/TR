import{s as ae,a as X,f as b,c as Y,g as y,h as Z,d as f,j as ee,i as z,v as S,w as j,x as ie,o as re,z as le,r as H,u as T,p as ce}from"../chunks/scheduler.7c1da786.js";import{l as de,g as D,P as L,G as v,a as ue}from"../chunks/gameRender.d8bcad45.js";import{S as me,i as he}from"../chunks/index.7a22757c.js";import{c as fe}from"../chunks/ModalValues.a888a47e.js";import{g as ge}from"../chunks/navigation.8a75274b.js";import{x as pe,n as R,h as we,y as ve,m as be,u as K,k as ye,v as Se,w as E,o as Ce,I as ke,s as $,p as Ie,e as q,d as _e,f as Ge,z as V,r as Te,l as De}from"../chunks/store.7f25bae6.js";const{window:M}=ue;function J(r){let s,i,n="Opponent Left",c,t,o="Reconnect",l,h;return{c(){s=b("div"),i=b("h2"),i.textContent=n,c=X(),t=b("button"),t.textContent=o,this.h()},l(d){s=y(d,"DIV",{class:!0});var u=Z(s);i=y(u,"H2",{"data-svelte-h":!0}),H(i)!=="svelte-13hca7w"&&(i.textContent=n),c=Y(u),t=y(u,"BUTTON",{"data-svelte-h":!0}),H(t)!=="svelte-m9lzds"&&(t.textContent=o),u.forEach(f),this.h()},h(){ee(s,"class","disconnected-message")},m(d,u){z(d,s,u),T(s,i),T(s,c),T(s,t),l||(h=S(t,"click",r[2]),l=!0)},p:j,d(d){d&&f(s),l=!1,h()}}}function Le(r){let s,i,n,c,t=r[1]&&J(r);return{c(){t&&t.c(),s=X(),i=b("canvas"),this.h()},l(o){t&&t.l(o),s=Y(o),i=y(o,"CANVAS",{id:!0}),Z(i).forEach(f),this.h()},h(){ee(i,"id","rendering-canvas")},m(o,l){t&&t.m(o,l),z(o,s,l),z(o,i,l),r[6](i),n||(c=[S(M,"resize",r[5]),S(M,"keydown",r[3]),S(M,"keyup",r[4])],n=!0)},p(o,[l]){o[1]?t?t.p(o,l):(t=J(o),t.c(),t.m(s.parentNode,s)):t&&(t.d(1),t=null)},i:j,o:j,d(o){o&&(f(s),f(i)),t&&t.d(o),r[6](null),n=!1,ie(c)}}}async function Ee(){const r=localStorage.getItem("jwt");(await fetch("http://localhost:3000/user/enterGame",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).ok&&console.log("-[ Enter Game Button ]- ")}async function Q(){const r=localStorage.getItem("jwt");(await fetch("http://localhost:3000/user/leaveGame",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).ok&&console.log("-[ Leave Game ]- ")}async function Me(r){const s=localStorage.getItem("jwt");(await fetch("http://localhost:3000/user/matchHistory",{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify({data:r})})).ok&&console.log("-[ Match History ]-  Set !")}function ze(r,s,i){let n,c,t,o=!1,l=!1,h,d,u,A,P,x,C,O,g,U="john",W,k,I,N,m;re(()=>{g=new de.Client("ws://localhost:3000"),pe.set(g),R.set(!1),we.set(!0),Ee(),ve.subscribe(e=>{m=e}),be.subscribe(e=>{U=e}),K.subscribe(e=>{u=e}),ye.subscribe(e=>{A=e}),Se.subscribe(e=>{h=e}),E.subscribe(e=>{d=e}),Ce.subscribe(e=>{P=e}),ke.subscribe(e=>{x=e}),$.subscribe(e=>{W=e}),Ie.subscribe(e=>{O=e});const a=c.getContext("2d");if(!a)throw new Error("Failed to get 2D context.");return t=a,(async()=>(await te(),D(t,m),p(),F()))(),n==null||n.onLeave(e=>{e!==1e3&&B()}),window.addEventListener("resize",p),window.addEventListener("keydown",_),window.addEventListener("keyup",G),()=>{window.removeEventListener("resize",p),window.removeEventListener("keydown",_),window.removeEventListener("keyup",G)}}),le(()=>{n.send("player_disconnected",{messageDuFront:"Salut du Frontend onDestroy SveltKit !"}),n.leave(),V.set(!1),Q(),fe(),R.set(!0),console.log("Le composant [Game/Create] a été démonté.")});async function te(){try{q.subscribe(e=>{k=e}),_e.subscribe(e=>{I=e}),Ge.subscribe(e=>{C=e,console.log("gameRender:",C)});const a={speed:h,scoreToWin:d,loginName:u,id:A,username:U,idToInvite:P,loginToInvite:x,paddleSize:O,backgroundColor:C};V.set(!0),console.log(" [ initiationGame ] gameData: ",I),console.log(" [ initiationGame ] invited: ",k),k===!1?n=await g.create("privateRoom",a):(n=await g.joinById(I.roomId,a),q.set(!1)),m=n.state,n.onMessage("invitation",e=>{if(K.subscribe(w=>{N=w}),N===e.login){console.log(" [ room.onMessage(Invitation) ] data: ",e),Te.set(e.loginToInvite),De.set(e.login),E.set(e.scoreToWin),console.log("[ room.onMessage(Invitation) winnerScore.set(data.scoreToWin ] ",E.set(e.scoreToWin));let w;$.subscribe(oe=>{w=oe}),w.emit("sendGameInvitation",e)}}),n.onMessage("state",e=>{console.log("New game state received:",e)}),n.onMessage("startGame",e=>{}),n.onStateChange(e=>{m=e,D(t,m)}),n.onMessage("updateWinningScore",e=>{d=e.winningScore}),n.onMessage("scoreHistory",e=>{Me(e)}),n.onMessage("gameFinished",e=>{e.winnerLogin&&alert("Winner is '"+e.winnerLogin+"'"),Q()}),B()}catch(a){console.error("Failed to connect to the game server:",a)}}function B(){W.on("refuseCloseGame",(a,e)=>{e="the other player refused the game",alert(e),ge("/")})}function ne(){i(1,o=!1),l=!1}function _(a){if(!l)switch(a.key){case"ArrowUp":n.send("paddleMove",{newDirection:L.UP});break;case"ArrowDown":n.send("paddleMove",{newDirection:L.DOWN});break}}function G(a){if(!l)switch(a.key){case"ArrowUp":case"ArrowDown":n.send("paddleMove",{newDirection:L.STOP});break}}function p(){const a=Math.min(window.innerWidth/v.width,window.innerHeight/v.height);t.canvas.width=v.width*a,t.canvas.height=v.height*a,t.scale(a,a)}function F(){requestAnimationFrame(F),D(t,m)}function se(a){ce[a?"unshift":"push"](()=>{c=a,i(0,c)})}return[c,o,ne,_,G,p,se]}class We extends me{constructor(s){super(),he(this,s,ze,Le,ae,{})}}export{We as component};
